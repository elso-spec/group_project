---
title: "Presentation"
author: "Elisabeth Solmunde"
format: html
editor: visual
---

```{r setup, results='hide', message=FALSE, warning=FALSE}
# Packages
library(tidyverse)
library(ggplot2)
library(dplyr)
library(countrycode)
library(stringr)
library(gt)
library(viridis)
library(plotly)
library(sf)
library(gghalves)
library(rnaturalearth)
library(ggridges)


# Data
tuesdata <- tidytuesdayR::tt_load('2023-12-05')
life_expectancy <- tuesdata$life_expectancy
life_expectancy_different_ages <- tuesdata$life_expectancy_different_ages
life_expectancy_female_male <- tuesdata$life_expectancy_female_male
```

# Group project

## 1. Description of our data

We chose to use the data set *life_expectancy*, which consists of three data sets:

-   *life_expectancy*
-   *life_expectancy_female_male*
-   *life_expectancy_different_ages*

In this presentation, we focus on the first two data sets.

### 1.1 The *life_expectancy* data set

This data set contains the following variables:

-   Entity
    -   Is most often a country, but can also be regions (*e.g.* Europe, Americas), income groups (*e.g.* High-income countries, or development status (*e.g.* Developed countries))
-   Code
    -   Represents a country code (*e.g.* Afghanistan = AFG)
-   Year
    -   Self-explanatory?
-   LifeExpectancy
    -   The life expectancy in a country in that given year

**Let's take a quick look:**

```{r}
head(life_expectancy)
```

### 1.2 The *life_expectancy_female_male* data set

This data set contains the same variables as the abovementioned, expect for one:

-   LifeExpectancyDiffFM
    -   This variable is the difference in life expectancy between females and males in that given year

```{r}
head(life_expectancy_female_male)
```

## 2. Wrangling

First, we limit the follow-up time from 1950 to 2020. For the *life_expectancy* data set, we also add the variable *Decade*

```{r, message=FALSE, warning=FALSE}
life_expectancy <- life_expectancy |>
  filter(Year >= 1950 & Year <= 2020)

life_expectancy_female_male <- life_expectancy_female_male |>
  filter(Year >= 1950 & Year <= 2020)


life_expectancy <- life_expectancy |>
  mutate(Decade = case_when(Year >= 1950 & Year < 1960 ~ 1950,        # Create Decade columns 
                            Year >= 1960 & Year < 1970 ~ 1960,
                            Year >= 1970 & Year < 1980 ~ 1970,
                            Year >= 1980 & Year < 1990 ~ 1980,
                            Year >= 1990 & Year < 2000 ~ 1990,
                            Year >= 2000 & Year < 2010 ~ 2000,
                            Year >= 2010 & Year < 2020 ~ 2010)) |>
  filter(!is.na(Decade))                                              # Remove NAs
```

We then create the data sets life_expectancy_countries and life_expectancy_regions

```{r}
# This dataset contain only countries
life_expectancy_countries <- life_expectancy |>
  filter(!(is.na(Code) == T))                         # We remove rows with no Code, as these are assigned to countries only

life_expectancy_countries
```

```{r, warning=FALSE}
# This dataset contain only regions
life_expectancy_region <- life_expectancy |>
  filter(!(is.na(Code) == T)) |>
  mutate(
    Continent = countrycode(sourcevar = Entity,
                            origin = "country.name",
                            destination = "continent"),
    Region = countrycode(sourcevar = Entity,
                         origin = "country.name",
                         destination = "region")
  ) |>
  filter(!is.na(Region))

life_expectancy_region
```

## 3. Visualization

**First, lets take a look at the changes in life expectancy over time:**

We'll start by looking at the continents, and then regions

```{r, message = FALSE, warning = FALSE}
life_expectancy_region |> 
  filter(!is.na(Continent)) |> 
  group_by(Continent, Decade) |> 
  summarise(mean_life_expectancy = mean(LifeExpectancy)) |> 
  ggplot(aes(x = Decade, y = mean_life_expectancy, color = Continent), na.rm = T) +
  geom_point() + 
  geom_smooth(se = F) + 
  scale_x_continuous(breaks = seq(1950, 2020, by = 10)) +
  theme_classic() +
  labs(
    x = "Year",
    y = "Mean life expectancy (years)",
    title = "Mean life expectancies from 1950 to 2020, by continent"
  )
```

```{r, message=FALSE, warning=FALSE}
life_expectancy_region |> 
  filter(!is.na(Region)) |> 
  group_by(Region, Decade) |> 
  summarise(mean_life_expectancy = mean(LifeExpectancy)) |> 
  ggplot(aes(x = Decade, y = mean_life_expectancy, color = Region), na.rm = T) +
  geom_point() + 
  geom_smooth(se = F) + 
  scale_x_continuous(breaks = seq(1950, 2020, by = 10)) +
  theme_classic() +
  labs(
    x = "Year",
    y = "Mean life expectancy (years)",
    title = "Mean life expectancies from 1950 to 2020, by region"
  )
```

```{r, message=FALSE, warning=FALSE}
# Life expectancy by region (1950-2020)
life_expectancy_region |> 
  group_by(Region, Year) |> 
  summarise(mean_le = mean(LifeExpectancy)) |> 
  ggplot(aes(x = Year, y = Region, fill = mean_le)) +
  geom_tile() +
  scale_fill_viridis_c(option = "plasma", name = "Life Expectancy") +
  labs(title = "Life Expectancy by Region (1960–2020)",
       x = "Year", y = "Region") +
  theme_minimal() +
  theme(axis.text.y = element_text(size = 6))
```

```{r, fig.height=20, fig.width=12, message=FALSE, warning=FALSE}
# Life expectancy by country (1950-2020)
ggplot(life_expectancy_region, aes(x = Year, y = Entity, fill = LifeExpectancy)) +
  geom_tile() + 
  facet_wrap( ~ Continent, scales = "free_y") +
  scale_fill_viridis_c(option = "plasma", name = "Life Expectancy") +
  labs(title = "Life Expectancy by Country (1960–2020)",
       x = "Year", y = "Country") +
  theme_minimal() +
  theme(axis.text.y = element_text(size = 6)) 
  
```

**Then, lets see the information per country**

First, generate a world heatmap with the average Life Expectancy per country per decade, starting from 1920

```{r}
##Add the continents to the data
le_continent <- life_expectancy %>%
  mutate(continent = countrycode(Entity, origin = "country.name", destination = "continent"))


##Split in decades
le_continent <- le_continent %>%
  mutate(decade = floor(Year / 10) * 10)

by_decade <- split(le_continent, le_continent$decade)

names(by_decade)

# Make a working data frame
df <- le_continent_subset %>% as_tibble()

# Country-by-decade average (from 1920s onward)
df_country_dec <- df %>%
  mutate(
    decade = (Year %/% 10) * 10,
    Code   = trimws(Code)
  ) %>%
  # keep real countries (valid ISO3 codes) and decades >= 1920
  filter(!is.na(Code), Code != "", nchar(Code) == 3, grepl("^[A-Za-z]{3}$", Code),
         decade >= 1920) %>%
  group_by(Code, Entity, decade) %>%
  summarise(avg_lifeexp = mean(LifeExpectancy, na.rm = TRUE), .groups = "drop")

# Consistent colors across decades
zmin <- floor(min(df_country_dec$avg_lifeexp, na.rm = TRUE))
zmax <- ceiling(max(df_country_dec$avg_lifeexp, na.rm = TRUE))

# ANIMATED MAP (all decades from 1920s)
# =======================
p_anim <- plot_ly(
  df_country_dec,
  type         = "choropleth",
  locations    = ~Code, locationmode = "ISO-3",
  z            = ~avg_lifeexp,
  frame        = ~decade,
  text         = ~paste0(
    "<b>", Entity, "</b><br>",
    "Decade: ", decade, "<br>",
    "Life expectancy: ", round(avg_lifeexp, 1)
  ),
  hoverinfo    = "text",
  colorscale   = "Viridis",
  zmin         = zmin, zmax = zmax
) %>%
  layout(
    title = "Average life expectancy by country — animated by decade (from 1920s)",
    geo = list(
      showframe = FALSE,
      showcoastlines = FALSE,
      showcountries = TRUE,
      projection = list(type = "natural earth")
    )
  )

# Save animated map into a HTML file
saveWidget(p_anim, "worldheatmap.html", selfcontained = TRUE)


```

The world heatmap represents the global tendencies, continent differences remain similar decade after decade.

Now, lets see the information of the differences between females and males per country per decade.

```{r}
##Load the data and make your working dataframe
df <- life_expectancy_female_male %>% as_tibble()

# Gap (Females − Males)
if ("LifeExpectancyDiffFM" %in% names(df)) {
  df <- df %>% mutate(Gap = LifeExpectancyDiffFM)
} else if (all(c("LE_Female", "LE_Male") %in% names(df))) {
  df <- df %>% mutate(Gap = LE_Female - LE_Male)
} else {
  stop("cant find 'LifeExpectancyDiffFM' or 'LE_Female/LE_Male' in the df.")
}

# Clean codes and add decades
df <- df %>%
  mutate(
    Code   = trimws(Code),
    decade = (Year %/% 10) * 10
  ) %>%
  filter(
    !is.na(Code), Code != "",
    nchar(Code) == 3, grepl("^[A-Za-z]{3}$", Code),
    decade >= 1950
  )

# Mean per country per decade, exclude NA
df_dec <- df %>%
  group_by(Entity, Code, decade) %>%
  summarise(Gap = mean(Gap, na.rm = TRUE), .groups = "drop") %>%
  filter(!is.na(Gap)) %>%
  mutate(
    Sign = ifelse(Gap >= 0, "Females > Males", "Males > Females"),
    decade_str = as.character(decade) # frames as texto
  )

pal2 <- c("#ef476f", "#06d6a0")

# Simetric
lim <- max(abs(range(df_dec$Gap, na.rm = TRUE)))
xrange <- c(-lim, lim)

# Buttons per decade
decades <- sort(unique(df_dec$decade_str))
btns <- lapply(decades, function(d) {
  list(
    label = paste0(d, "s"),
    method = "animate",
    args = list(
      list(d),
      list(mode = "immediate",
           frame = list(duration = 0, redraw = TRUE),
           transition = list(duration = 0))
    )
  )
})

p_btns <- plot_ly(
  df_dec,
  x = ~Gap, y = ~Entity,
  frame = ~decade_str,
  type = "bar", orientation = "h",
  color = ~Sign, colors = pal2,
  hovertemplate = paste(
    "<b>%{y}</b><br>",
    "Decade: %{frame}<br>",
    "Gap (Females − Males): %{x:.2f} years<extra></extra>"
  )
) %>%
  layout(
    title = "Life Expectancy gap per Country — Decades (since 1950)",
    xaxis = list(title = "Years (positive = Females > Males)"),
    yaxis = list(title = ""),
    barmode = "relative",
    height = 800,
    updatemenus = list(
      list(
        type = "buttons",
        direction = "right",
        x = 1, xanchor = "right",
        y = 1.12, yanchor = "top",
        buttons = btns          # just decades
      )
    )
  ) %>%
  animation_slider(hide = TRUE) %>%   # hide slider
  animation_button(hide = TRUE)       # hide Play 

# Save as interactive HTML
saveWidget(p_btns, "gap_bar_dec.html", selfcontained = TRUE)
```

The differential plot shows the gender gap and how it remains as females having a bigger life expectancy than males but we can observe some cases in the earlier decades where the males have bigger life expectancy for a few countries.
